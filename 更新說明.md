# 寵物成長系統更新說明

## 重要變更

### 1. 移除的欄位
- ❌ `growth_points`（成長點數）：不再使用
- ❌ `satiety`（飽食度）：不再使用

### 2. 新的升級系統

#### 力量值系統
- 運動每10秒 = 1點力量值
- 每級需要120點力量值（相當於現實世界20分鐘運動）
- 力量值達到120點後自動升級，力量值重置為0
- 最高等級：25級

#### 等級突破系統
- 在5、10、15、20級時需要進行等級突破
- **沒有突破前，力量值增加會被封鎖（變為0）**
- 前端需要顯示彈窗警告用戶需要進行突破
- 通過旅遊完成突破：`POST /users/{user_id}/travel/breakthrough`

### 3. 階段進化系統（已更新）
只有在完成突破後才會進化：
- 1-4級：蛋（EGG）
- 5級突破後：小雞（CHICK）
- 10級突破後：中雞（CHICKEN）
- 15級突破後：大雞（BIG_CHICKEN）
- 20級突破後：壯雞（BUFF_CHICKEN）

### 4. 心情值系統

#### 規則
- 初始值：0（原本是50）
- 每次運動：+5
- 每天00:00檢查前一天的運動量：
  - 如果前一天運動不足10分鐘（60點力量值）**且體力值>0**：
    - 心情值 -10
  - 如果心情值降至0 **且力量值>0**：
    - 力量值 -10
  - 如果體力值=0：不扣心情值（代表已運動足夠）

## 新的API端點

### 每日檢查
```
POST /users/{user_id}/daily-check
```
檢查昨天的運動量，並根據規則調整心情值。
建議在每天00:00或用戶登入時調用。

**回應：**
```json
{
  "pet": {...},
  "already_checked": false,
  "met_requirement": true
}
```

### 完成突破
```
POST /users/{user_id}/travel/breakthrough
```
完成等級突破，解鎖繼續升級的能力。

**回應：**
```json
{
  "success": true,
  "pet": {...},
  "message": "Breakthrough completed!"
}
```

### 開始旅行（取得隨機景點）
```
POST /users/{user_id}/travel/start
```
獲取一個隨機台北景點用於突破任務。

## 修改的API回應

### 運動記錄
```
POST /users/{user_id}/exercise
```
現在回應格式：
```json
{
  "pet": {...},
  "breakthrough_required": false
}
```
`breakthrough_required` 欄位指示是否需要完成突破。

## 資料庫遷移

**重要：資料庫結構已改變，需要重置資料庫！**

### 開發環境（推薦）
```bash
python reset_database.py
```

### 或手動執行SQL
```sql
-- 移除舊欄位
ALTER TABLE pets DROP COLUMN growth_points;
ALTER TABLE pets DROP COLUMN satiety;

-- 更新欄位預設值
ALTER TABLE pets ALTER COLUMN strength SET DEFAULT 0;
ALTER TABLE pets ALTER COLUMN stamina SET DEFAULT 100;
ALTER TABLE pets ALTER COLUMN mood SET DEFAULT 0;

-- 新增欄位
ALTER TABLE pets ADD COLUMN breakthrough_completed BOOLEAN DEFAULT FALSE;
ALTER TABLE pets ADD COLUMN last_daily_check TIMESTAMP WITH TIME ZONE;

-- 更新任務表
ALTER TABLE quests DROP COLUMN reward_growth;
ALTER TABLE quests DROP COLUMN reward_satiety;

-- 更新現有寵物資料
UPDATE pets SET 
  strength = 0,
  stamina = 100,
  mood = 0,
  breakthrough_completed = FALSE;
```

## 使用範例

### 1. 運動流程
```python
# 用戶運動5分鐘（300秒）
POST /users/1/exercise
{
  "exercise_type": "Running",
  "duration_seconds": 300,
  "volume": 5.0
}

# 回應：
{
  "pet": {
    "strength": 30,    # 300秒 / 10 = 30點
    "level": 1,
    "stamina": 90,     # 每次運動-10
    "mood": 5          # 每次運動+5
  },
  "breakthrough_required": false
}
```

### 2. 升級範例
```python
# 用戶有110力量值，運動2分鐘（120秒）
# 獲得12點 = 總共122點
# 122 >= 120，升級！
{
  "pet": {
    "strength": 2,     # 122 - 120 = 2點剩餘
    "level": 2,        # 等級提升
    "stamina": 100,    # 升級時恢復滿
    "mood": 15         # 升級獎勵+10
  },
  "breakthrough_required": false
}
```

### 3. 需要突破
```python
# 用戶達到5級
{
  "pet": {
    "strength": 0,
    "level": 5,
    "stage": 0,  # 仍是蛋，需要突破
    "breakthrough_completed": false
  },
  "breakthrough_required": true  # 前端應顯示警告
}

# 調用 POST /users/1/travel/breakthrough 後
{
  "success": true,
  "pet": {
    "level": 5,
    "stage": 1,  # 現在是小雞了！
    "breakthrough_completed": true
  },
  "message": "Breakthrough completed!"
}
```

### 4. 每日檢查
```python
# 用戶昨天沒有運動足夠
POST /users/1/daily-check

{
  "pet": {
    "mood": 40,  # 從50減少到40
    "strength": 50
  },
  "already_checked": false,
  "met_requirement": false
}

# 如果心情值降至0且力量值>0
{
  "pet": {
    "mood": 0,
    "strength": 40  # 從50減少到40
  },
  "already_checked": false,
  "met_requirement": false
}
```

## 前端整合注意事項

1. **突破警告**：當收到 `breakthrough_required: true` 時，顯示彈窗提醒用戶需要完成突破才能繼續獲得力量值。

2. **每日檢查**：在應用啟動時或每天00:00調用 `/users/{user_id}/daily-check`。

3. **力量值進度條**：顯示力量值為進度條（0-120），表示距離下一級的進度。

4. **階段進化**：階段只在完成突破後改變，不會在到達等級里程碑時自動改變。

5. **心情值指示器**：顯示心情值（0-100），當數值較低時顯示警告。

## 常數參考

```python
STRENGTH_PER_LEVEL = 120      # 每級需要的力量值
MIN_DAILY_STRENGTH = 60       # 每日最低要求（10分鐘）
MAX_LEVEL = 25                # 最高等級
BREAKTHROUGH_LEVELS = [5, 10, 15, 20]  # 需要突破的等級
```

## 測試腳本

執行測試腳本以驗證新系統：
```bash
# 先啟動伺服器
uvicorn app.main:app --reload

# 在另一個終端運行測試
python test_new_system.py
```
